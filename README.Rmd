---
output: 
  github_document
editor_options: 
  chunk_output_type: console
---

<!-- README.md is generated from README.Rmd. Please only edit the Rmd file -->

```{r, echo = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "inst/vignette-supp/",
  echo=TRUE, 
  warning=FALSE, 
  message=FALSE,
  tidy=TRUE
)
```

<!-- badges: start -->
[![R-CMD-check](https://github.com/gtonkinhill/strainspy/workflows/R-CMD-check-hard/badge.svg)](https://github.com/gtonkinhill/strainspy/actions)
<!-- [![DOI](https://zenodo.org/badge/XXXX.svg)](https://zenodo.org/badge/latestdoi/XXXX) -->
<!-- badges: end -->


# Strainspy

## Installation

`strainspy` is currently available on github. It can be installed with `remotes`

```{r, eval = FALSE}
install.packages("remotes")
remotes::install_github("gtonkinhill/strainspy")
```


If you would like to also build the vignette with your installation run:
```{r, eval=FALSE}
remotes::install_github("gtonkinhill/strainspy", build_vignettes = TRUE)
```
## Example

This walkthrough demonstrates a typical `strainspy` analysis and showcases some of the models and outputs available. Here, we analyse a 200 sample subset of the data described in [Wallen *et al.* 2022](https://doi.org/10.1038/s41467-022-34667-x).

**NOTE:** Be sure to replace the example paths with valid file paths on your system. The `system.file()` function is used here only for demonstration purposes in this vignette and will not work outside the package environment.

```{r, fig.width =8, fig.height=6, fig.align='center'}
library(strainspy)

example_meta_path <- system.file("extdata", "example_metadata.csv.gz", package = "strainspy")
example_sylph_path <- system.file("extdata", "example_sylph_profile.tsv.gz", package = "strainspy")
example_taxonomy_path <- system.file("extdata", "example_taxonomy.tsv.gz", package = "strainspy")
```

### Load and filter data

```{r}
# Read in metadata
meta_data <- readr::read_csv(example_meta_path)
meta_data$Case_status = factor(meta_data$Case_status) # Required for visualising
# Read in sylph profile
se <- read_sylph(example_sylph_path, meta_data)

# Filter by presence. This will remove any strains that are not present in at least 30 samples
se <- filter_by_presence(se, min_nonzero = 30)
```

### Fit the model

```{r}
# Create design matrix
design <- as.formula(" ~ Case_status + Age_at_collection")

# Fit a Zero-inflated beta model
fit <- glmZiBFit(se,  design, nthreads=parallel::detectCores())
```

### Summarise and plot the results

```{r, fig.width=8, fig.asp=0.75, out.width='100%'}
# Get top hits
top_hits(fit, alpha = 0.5)

# Create Volcano plot
plot_volcano(fit, label = T, alpha = 0.5)
```

## Visualise the distribution of top hits with Case_status

### Including zeros
```{r, fig.width=8, fig.asp=0.75, out.width='100%'}
plot_ani_dist(se, 'Case_status', top_hits(fit, alpha = 0.5)$Contig_name, show_points = T)
```

### Excluding zeros
```{r, fig.width=8, fig.asp=0.75, out.width='100%'}
plot_ani_dist(se, 'Case_status', top_hits(fit, alpha = 0.5)$Contig_name, show_points = T, drop_zeros = T)
```

## Incorporate taxonomy

```{r, fig.width=8, fig.asp=0.75, out.width='100%'}
# Read in taxonomy
taxonomy <- read_taxonomy(example_taxonomy_path)

# Perform hierarchical multiple testing adjustment of p-values
hier_p <- hadjust(fit, taxonomy=taxonomy)
head(hier_p)
```

### Create taxonomy informed Manhattan plot with adjusted p-values
```{r, fig.width=8, fig.asp=0.75, out.width='100%'}
plot_manhattan(fit, taxonomy = taxonomy)
```

### Create a traditional Manhattan plot coloured by taxonomy with unadjusted p-values and Bonferroni significance thresholds
```{r, fig.width=10, fig.height=6}
plot_manhattan(fit, taxonomy = taxonomy, aggregate_by_taxa = F)
```

## Example using Sourmash output
```{r}
example_sourmash_path <- system.file("extdata", "example_sourmash.csv.gz", package = "strainspy")
sm <- read_sourmash(example_sourmash_path, meta_data)
```
All remaining functions are compatible with this output. 

**Note:** `strainspy` provides a function to merge `sourmash gather` and `sourmash search` outputs. See help for details.

## Example using MetaPhlAn output
```{r}
example_metaphlan_path <- system.file("extdata", "metaphlan_merged.tsv.gz", package = "strainspy")
example_taxonomy_path <- system.file("extdata", "metaphlan_taxonomy.tsv.gz", package = "strainspy")
mp <- read_metaphlan(example_metaphlan_path, meta_data)
```
All remaining functions are compatible with this output. 

**Note:** `strainspy` provides a function to merge `MetaPhlAn` profiles and generate the taxonomy file. See help for details.


## Citation

To cite strainspy please use

